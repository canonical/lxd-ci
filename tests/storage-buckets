#!/bin/sh
set -eux

poolDriverList="${1:-dir btrfs lvm lvm-thin zfs ceph}"

# Install LXD
install_lxd
snap set lxd ceph.external=true
lxd waitready --timeout=300

# Install dependencies
apt-get update
apt-get install --no-install-recommends --yes ceph-common

# Configure LXD
lxc project switch default
lxc project create test -c features.images=false
lxc project switch test

poolName="bucketpool$$"

for poolDriver in $poolDriverList
do
  echo "==> Create storage pool using driver ${poolDriver}"
  if [ "${poolDriver}" = "dir" ]; then
    lxc storage create "${poolName}" "${poolDriver}" volume.size=5GB
  elif [ "${poolDriver}" = "ceph" ]; then
    lxc storage create "${poolName}" cephobject cephobject.radosgw.endpoint="${LXD_CEPH_CEPHOBJECT_RADOSGW}"
  elif [ "${poolDriver}" = "lvm" ]; then
    lxc storage create "${poolName}" "${poolDriver}" size=40GiB lvm.use_thinpool=false volume.size=5GB
  elif [ "${poolDriver}" = "lvm-thin" ]; then
    lxc storage create "${poolName}" lvm size=20GiB volume.size=5GB
  else
    lxc storage create "${poolName}" "${poolDriver}" size=20GB volume.size=5GB
  fi

  if [ "${poolDriver}" != "ceph" ]; then
    lxc config set core.storage_buckets_address "127.0.0.1:9000"
  fi

  lxc storage show "${poolName}"

  echo "==> Creating buckets"
  lxc storage bucket create "${poolName}" bucket1

  echo "==> Deleting buckets and storage pool"
  lxc storage bucket delete "${poolName}" bucket1
  lxc storage rm "${poolName}"
done

lxc project switch default
lxc project delete test

# shellcheck disable=SC2034
FAIL=0
